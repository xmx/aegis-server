<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE 日志查看器</title>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-json.min.js"></script>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: monospace, Simsun, sans-serif;
            font-size: 14px;
        }

        .truncate-text {
            display: inline-block;
            max-width: 60ch;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-black text-white">
<div class="flex h-screen">
    <!-- 左侧日志列表 -->
    <div class="w-1/3 bg-black overflow-auto p-4">
        <ul id="logList" class="space-y-2"></ul>
    </div>

    <!-- 右侧日志详情 -->
    <div class="w-2/3 bg-gray-900 p-4 overflow-auto">
        <pre class="p-4 bg-gray-800 rounded" style="font-family: monospace, Simsun; font-size: 13px;"><code
                id="logDetail" class="language-json"></code></pre>
    </div>
</div>

<script>
    const logList = document.getElementById("logList");
    const logDetail = document.getElementById("logDetail");
    let logs = [];
    let selectedLogIndex = null;

    function updateLogList() {
        logList.innerHTML = logs.map((log, index) => {
            const time = new Date(log.time).toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3
            });

            return `<li class="p-2 cursor-pointer border-b border-gray-700 hover:bg-gray-700 ${index === selectedLogIndex ? 'bg-gray-700' : ''}" onclick="showLogDetail(${index})">
                    ${logs.length - index}. ${time} - <span class="text-yellow-400">${log.level}</span> - <span class="truncate-text">${log.msg}</span>
                </li>`;
        }).join("");
    }

    function showLogDetail(index) {
        selectedLogIndex = index;
        logDetail.innerHTML = Prism.highlight(JSON.stringify(logs[index], null, 2), Prism.languages.json, 'json');
        updateLogList();
    }

    const eventSource = new EventSource("/api/sse/log/tail");
    eventSource.onmessage = function (event) {
        const log = JSON.parse(event.data);
        logs.unshift(log);
        if (logs.length > 500) logs.pop();

        if (selectedLogIndex === null) {
            logDetail.innerHTML = Prism.highlight(JSON.stringify(log, null, 2), Prism.languages.json, 'json');
        }
        updateLogList();
    };
</script>
</body>
</html>
