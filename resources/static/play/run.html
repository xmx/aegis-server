<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„šæœ¬è¿è¡Œå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/ibm-plex-mono/index.min.css">
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">
<div class="flex-1 p-2">
    <div id="editor" class="h-1/2 border border-gray-700"></div>
    <div class="h-1/2 bg-black p-2 border border-gray-700 overflow-auto font-mono text-sm" id="console"></div>
</div>

<div class="flex p-2 gap-2">
    <button id="run" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 flex items-center">
        â–¶ï¸ è¿è¡Œ
    </button>
    <button id="clear" class="bg-yellow-800 hover:bg-red-700 text-white py-1 px-3 flex items-center">
        ğŸ—‘ï¸ æ¸…é™¤
    </button>
    <button id="kill" class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 flex items-center">
        â˜ ï¸ ç»“æŸè¿›ç¨‹
    </button>
</div>

<script>
    let editor;
    let socket = new WebSocket("/api/ws/play/js"); // æ›´æ–° WebSocket åœ°å€

    let code = localStorage.getItem("code");
    if (!code) {
        code = `// æ ·ä¾‹ç¨‹åº
const runtime = require("runtime")
const crontab = require("crontab")

// æ¯ç§’é‡‡é›†ç¨‹åºå†…å­˜
let num = 0
crontab.addJob("* * * * * *", () => {
    num++
    const stats = runtime.memStats()
    const limit = 10000000
    const alloc = stats.alloc
    if (alloc <= limit) {
        console.log("å†…å­˜å ç”¨æ­£å¸¸ï¼š", alloc)
    } else {
        console.error("[" + new Date().toJSON() + "] å†…å­˜å ç”¨ " + alloc + "è¶…è¿‡ " + limit + " é™åˆ¶ï¼Œè¯·å¤„ç†")
    }
    if (num === 3) {
        console.log("å¼€å§‹ç”³è¯·å¤§å†…å­˜")
        new ArrayBuffer(10240000) // æ¨¡æ‹Ÿç”³è¯·å¤§å†…å­˜
    } else if (num === 7) {
        console.log("å›æ”¶å†…å­˜")
        runtime.gc() // å›æ”¶å†…å­˜
    }
})
`
    }
    require.config({paths: {'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs'}});
    require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('editor'), {
            value: code,
            language: 'javascript',
            theme: 'vs-dark',
            fontFamily: 'Consolas, monospace',
        });
    });

    document.getElementById("run").addEventListener("click", function () {
        const code = editor.getValue();
        localStorage.setItem("code", code);
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({type: "exec", data: code}));
        } else {
            consoleRed("æœªè¿æ¥æœåŠ¡å™¨");
        }
    });
    document.getElementById("kill").addEventListener("click", function () {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({type: "kill"}));
        } else {
            consoleRed("æœªè¿æ¥æœåŠ¡å™¨");
        }
    });
    document.getElementById("clear").addEventListener("click", function () {
        document.getElementById("console").innerHTML = "";
    });

    socket.onopen = function () {
        consoleGreen("è¿æ¥æœåŠ¡å™¨æˆåŠŸ");
    };

    socket.onmessage = function (evt) {
        const msg = JSON.parse(evt.data);
        if (msg.type === "stdout") {
            consoleGray(msg.data);
        } else if (msg.type === "stderr") {
            consoleRed(msg.data)
        } else {
            consoleRed("æœªçŸ¥çš„æ¶ˆæ¯ç±»å‹ï¼š", evt.data)
        }
    };

    socket.onerror = function () {
        consoleRed("è¿æ¥å‘ç”Ÿé”™è¯¯");
    };

    socket.onclose = function () {
        consoleRed("æœåŠ¡å™¨è¿æ¥å·²å…³é—­");
    };

    function consoleOutput(msg, colorClass) {
        const consoleDiv = document.getElementById("console");
        consoleDiv.innerHTML += `<div class='${colorClass}'><pre>${msg}</pre></div>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function consoleGreen(msg) {
        consoleOutput(msg, "text-green-400");
    }

    function consoleRed(msg) {
        consoleOutput(msg, "text-red-300");
    }

    function consoleGray(msg) {
        consoleOutput(msg, "text-gray-300");
    }

</script>
</body>
</html>