<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>下载</title>
    <style>
        body {
            background: #121212;
            color: #e6e6e6;
            font-family: sans-serif;
            margin: 0;
            height: 100vh;

            /* 居中核心：Flex + 水平/垂直居中 */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 320px;
            text-align: center;
        }

        h2 {
            color: #fafafa;
            margin-bottom: 28px;
        }

        select, button {
            display: block;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: "IBM Plex Mono", Consolas, "Segoe UI", sans-serif;
            margin-top: 14px;

            border-radius: 6px;
            border: 1px solid #333;
            background: #1e1e1e;
            color: #e6e6e6;
        }

        button {
            cursor: pointer;
            background: #2b2b2b;
            border: 1px solid #444;
            transition: background 0.15s;
            margin-top: 22px;
        }

        button:hover {
            background: #3a3a3a;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- 移除所有文本提示，仅保留选择框 -->
    <select id="os"></select>
    <select id="arch"></select>
    <button id="downloadBtn">下载</button>
</div>

<script>
    async function fetchPlatforms() {
        try {
            const resp = await fetch("/api/agent-release/platforms", {
                method: "GET",
                headers: {"Accept": "application/json"}
            });
            if (!resp.ok) throw new Error("failed to load platforms");

            return await resp.json();
        } catch (err) {
            console.error("加载平台信息失败:", err);
            return [];
        }
    }

    function detectOS() {
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes("windows")) return "windows";
        if (ua.includes("android")) return "android";
        if (ua.includes("mac os") || ua.includes("darwin")) return "darwin";
        if (ua.includes("linux")) return "linux";
        return "";
    }

    function detectArch() {
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes("arm64") || ua.includes("aarch64")) return "arm64";
        return "amd64";
    }

    function fillSelect(select, values) {
        select.innerHTML = "";
        values.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            select.appendChild(opt);
        });
    }

    // 主入口
    (async function init() {
        const osSelect = document.getElementById("os");
        const archSelect = document.getElementById("arch");

        const platforms = await fetchPlatforms();

        if (platforms.length === 0) {
            // fallback：保留原静态选项，不自动填充
            console.warn("平台数据为空，使用静态选项");
            return;
        }

        // 填充 OS 下拉列表
        const allOS = platforms.map(p => p.field);
        fillSelect(osSelect, allOS);

        // OS 切换时更新 arch 列表
        osSelect.onchange = function () {
            const selectedOS = osSelect.value;
            const p = platforms.find(x => x.field === selectedOS);
            if (p) fillSelect(archSelect, p.values);
        };

        // 自动探测 OS / Arch 并选择合法组合
        const detectedOS = detectOS();
        const detectedArch = detectArch();

        if (allOS.includes(detectedOS)) {
            osSelect.value = detectedOS;
            const p = platforms.find(x => x.field === detectedOS);
            fillSelect(archSelect, p.values);

            if (p.values.includes(detectedArch)) {
                archSelect.value = detectedArch;
            }
        } else {
            // 使用默认第一个
            osSelect.value = allOS[0];
            const p = platforms[0];
            fillSelect(archSelect, p.values);
        }
    })();

    // 下载按钮
    document.getElementById("downloadBtn").onclick = function () {
        const os = document.getElementById("os").value;
        const arch = document.getElementById("arch").value;

        const url = `/api/agent-release?goos=${encodeURIComponent(os)}&goarch=${encodeURIComponent(arch)}`;
        window.location.href = url;
    };
</script>

</body>
</html>
